/**
 * 
 */
package com.liangshan.jianjian.android;

import java.io.File;
import java.text.SimpleDateFormat;
import java.util.Date;

import android.app.Activity;
import android.content.ActivityNotFoundException;
import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.Intent;
import android.content.IntentFilter;
import android.os.Bundle;
import android.os.Environment;
import android.util.Log;
import android.view.Gravity;
import android.view.View;
import android.view.Window;
import android.view.View.OnClickListener;
import android.widget.Button;
import android.widget.Toast;

/**
 * @author ezhuche
 *
 */
public class TakePhotoActivity extends Activity {
    public static final String TAG = "TakePhotoActivity";
    public static final boolean DEBUG = JianjianSettings.DEBUG;
    private Button mCameraButton;
    private Button mGallaryButton;
    
    private static final int CAMERA_WITH_DATA = 3023;  
    
    /*用来标识请求gallery的activity*/  
    private static final int PHOTO_PICKED_WITH_DATA = 3021;  
  
    /*拍照的照片存储位置*/  
    private static final File PHOTO_DIR = new File(Environment.getExternalStorageDirectory() + "/DCIM/Camera");  
  
    private File mCurrentPhotoFile;//照相机拍照得到的图片  
    
    private BroadcastReceiver mLoggedOutReceiver = new BroadcastReceiver() {
        @Override
        public void onReceive(Context context, Intent intent) {
            if (DEBUG) Log.d(TAG, "onReceive: " + intent);
            finish();
        }
    };
    
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        if (DEBUG) Log.d(TAG, "onCreate()");
        requestWindowFeature(Window.FEATURE_INDETERMINATE_PROGRESS);
        setContentView(R.layout.take_photo_activity);
        
        registerReceiver(mLoggedOutReceiver, new IntentFilter(Jianjianroid.INTENT_ACTION_LOGGED_OUT));

        mCameraButton.setOnClickListener(new OnClickListener() {

            @Override
            public void onClick(View v) {
                // TODO Auto-generated method stub
                String status=Environment.getExternalStorageState();  
                if(status.equals(Environment.MEDIA_MOUNTED)){//判断是否有SD卡  
                    doTakePhoto();// 用户点击了从照相机获取  
                }  
                else{  
                    showToast(getResources().getString(R.string.no_sd_text)); 
                }  
            }
            
        });
        
        mGallaryButton.setOnClickListener(new OnClickListener() {

            @Override
            public void onClick(View v) {
                // TODO Auto-generated method stub
                doPickPhotoFromGallery();
            }
            
        });

    }

    /**
     * @param string
     */
    protected void showToast(String string) {
        // TODO Auto-generated method stub
        Toast toast = Toast.makeText(getApplicationContext(),
                string, Toast.LENGTH_LONG);
        toast.setGravity(Gravity.CENTER, 0, 0);
        toast.show();
    }

    /**
     * 
     */
    protected void doPickPhotoFromGallery() {
        // TODO Auto-generated method stub
        
    }

    /**
     * 
     */
    protected void doTakePhoto() {
        // TODO Auto-generated method stub
        try {  
            // Launch camera to take photo for selected contact  
            PHOTO_DIR.mkdirs();// 创建照片的存储目录  
            mCurrentPhotoFile = new File(PHOTO_DIR, getPhotoFileName());// 给新照的照片文件命名  
            final Intent intent = getTakePickIntent(mCurrentPhotoFile);  
            startActivityForResult(intent, CAMERA_WITH_DATA);  
        } catch (ActivityNotFoundException e) {  
            Toast.makeText(this, R.string.photoPicker_NotFound_Text,  
                    Toast.LENGTH_LONG).show();  
        }  
    }
    
    /**
     * @param mCurrentPhotoFile2
     * @return
     */
    private Intent getTakePickIntent(File mCurrentPhotoFile2) {
        // TODO Auto-generated method stub
        return null;
    }

    /** 
     * 用当前时间给取得的图片命名 
     *  
     */  
    private String getPhotoFileName() {  
        Date date = new Date(System.currentTimeMillis());  
        SimpleDateFormat dateFormat = new SimpleDateFormat(  
                "'IMG'_yyyy-MM-dd HH:mm:ss");  
        return dateFormat.format(date) + ".jpg";  
    }  
    
}
